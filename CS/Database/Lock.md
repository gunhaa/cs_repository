# Lock

- 데이터베이스 관리 시스템(DBMS)에서 Lock은 여러 사용자가 동시에 같은 데이터에 접근할 때 발생하는 문제를 막기 위한 동시성 제어 메커니즘이다.
- 특정 트랜잭션이 데이터에 접근하는 동안 다른 트랜잭션의 접근을 제한하여 데이터의 일관성과 무결성을 보장하는 것이 핵심 역할이다

## Lock의 종류

> Lock(공유 락), X-Lock(배타 락), 그리고 갭 락(Gap Lock), 넥스트 키 락(Next-Key Lock) 이 데이터베이스 락의 핵심 베이스 개념이고, 실제 DB 락은 이들을 기반으로 응용하거나 조합하는 형태

1. 공유 Lock(Shared Lock, S-Lock)
   - 데이터를 읽을 때 사용한다
   - 하나의 데이터에 대해 여러 트랜잭션이 공유 Lock을 가질 수 있다
   - 하지만 공유 Lock이 걸린 데이터에 다른 트랜잭션이 수정을 위한 X-Lock을 획득할 수는 없다
2. 배타 Lock(Exclusive Lock, X-Lock)
   - 데이터를 변경(생성, 수정, 삭제)할 때 사용한다
   - 하나의 데이터에 대해 오직 하나의 트랜잭션만이 X-Lock을 가질 수 있다
   - X-Lock이 걸린 데이터에는 다른 어떤 트랜잭션도 접근할 수 없다
3. 갭 Lock (Gap Lock) 과 넥스트 키 Lock (Next-Key Lock)
   - 갭락: 특정 범위(Gap) 에 새로운 데이터가 추가되는 것을 방지한다
     - `select * from member where age > 15 for update`, `update member set age = age +1 where age > 15` 구문(update,delete, select ... for update)등 이용해 명시적으로 걸 수 있다
4. 넥스트 키 락: 기존 레코드 + 그 주변 갭 모두 잠그는 것이다
   - MySQL(InnoDB)의 REPEATABLE READ 격리 수준에서 기본적으로 사용되어 데이터와 그 주변 공간까지 함께 잠근다

## Lock의 범위

1. Database Level Lock: 데이터 베이스 전체를 잠그는 가장 큰 단위의 Lock, db 구조를 변경하는 등 극히 드문 경우 사용
2. Table Level Lock: 테이블 전체를 잠그며, 테이블의 스키마를 변경하는 DDL구문이 실행될 때 주로 사용된다. 해당 테이블을 사용하는 모든 트랜잭션을 대기시킨다
3. Block Level Lock(=Page Level Lock): 디스크에 데이터를 저장하는 기본 단위인 블록(=페이지, 블록은 물리적관점/페이지는 논리적 관점의 용어임)을 잠근다. 하나의 페이지에는 여러 개의 행이 포함될 수 있으므로, 행 잠금보다는 동시성이 낮고 테이블 잠금보다는 높다
4. Row Level Lock(=Record Level Lock): 하나의 row(=record)를 잠구는 가장 작은 단위의 Lock이다. 동시성이 가장 높기 때문에 대부분의 현대적인 DBMS(InnoDB)가 기본적으로 사용하지만, Lock 관리에 많은 자원이 소모될 수 있다


## Lock으로 발생하는 문제

- Lock은 데이터 무결성을 지키는 필수 요소지만, 잘못 사용되거나 특정 상황에서는 문제가 발생할 수 있다
  - 데드락: 두 개 이상의 트랜잭션이 lock을 획득한 상태에서 서로가 상대방의 lock이 해제되기를 무한정 기다리는 상태

## Lock 최적화 아이디어

- Lock 보유 시간 최소화: 트랜잭션을 가능한 짧게 설계하여 빨리 커밋하면 Lock이 점유되는 시간이 줄어들어 다른 트랜잭션의 대기 시간을 감소시킨다
  - Lock이 빨리 해제될수록 시스템 전체의 처리량이 증가한다
- 실천 방안: 데이터베이스와 무관한 로직(외부 API 호출, 복잡한 연산 등)은 트랜잭션 범위 밖에서 수행해야한다
