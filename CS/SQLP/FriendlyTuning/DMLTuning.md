# DML 튜낭

## 기본 DML 튜닝

### 인덱스

- 테이블에 레코드가 입력되면 인덱스에도 입력해야한다
- 테이블은 Freelist(테이블마다 데이터 입력이 가능한 블록 목록)를 통해 입력할 블록을 할당 받는다
- 인덱스는 정렬된 자료구조 이므로 수직적 탐색을 통해 입력할 블록을 찾아야 한다
  - 인덱스에 입력하는 과정이 더 복잡하므로 DML 성능에 미치는 영향이 더 크다
  - insert, delete는 한번의 연산이 발생하지만, update의 경우 위치도 바꿔야하기 때문에 두번의 연산이 발생한다
- 인덱스 개수가 DML 성능에 미치는 영향이 매우 크다
- 핵심 트랜잭션 테이블에서 인덱스 하나라도 줄이면 TPS(transaction per second)는 그만큼 향상된다

#### 인덱스 개수에 따른 DML 성능 테스트

- 테이블에 레코드 100만개 삽입
  - 삽입 시간 5초
- idx 2개 추가 생성 후 레코드 100만개 삽입
  - 삽입 시간 40초
- idx 2개 추가로 인해 삽입 시간 8배 증가

### 무결성 제약과 DML성능

- PK, FK 제약은 Check, NN 제약보다 성능에 더 큰 영향을 미친다
- Check, NN은 제약 조건을 준수하는지만 확인하면 되지만 PK, FK 제약은 실제 데이터를 조회해야 하기 떄문이다
  - PK는 unique, nn조건을 합친 것이여서 중복을 체크하기위해 조회해야한다
- 인덱스 개수에 따른 테스트한 테이블에서 PK를 제거 후 100만개의 데이터를 삽입하면 1.32초가 걸린다

### Redo 로깅과 DML 성능

- 오라클은 데이터파일과 컨트롤 파일에 가해지는 모든 변경사항을 Redo로그에 기록한다
- Redo로그는 트랜잭션 데이터가 어떤 이유에서건 유실됐을 때, 트랜잭션을 재현함으로써 유실 이전 상태로 복구하는 데 사용된다
- DML을 수행할 때마다 Redo 로그를 생성해야 하므로 Redo 로깅은 DML 성능에 영향을 미친다

#### Redo 로그

- Redo 로그는 세가지 목적에 사용된다
  1. Database Recovery
  2. Cache Recovery(Instance Recovery 시 roll forward 단계)
  3. Fast Commit

### Undo 로깅과 DML 성능

- 과거에는 Rollback이라는 용어를 사용했지만 오라클은 9i 부터 Undo라는 용어를 사용한다
  - Redo: 과거를 현재에 재현하기 위한 것(트랜잭션 재현)
  - Undo: 현재를 과거에 재현하기 위한 것(트랜잭션을 롤백함으로써 현재를 과거 상태로 되돌리는데 사용/변경된 블록을 이전상태로 되돌리는데 필요한 정보)

### Redo log 와 Undo log 사용 예시

```sql
-- 트랜잭션 시작
BEGIN;

-- DML 실행
UPDATE users SET age = 30 WHERE id = 1;
```

## Undo / Redo 로그에 저장되는 정보

| 구분      | 저장되는 내용                              | 목적                             |
|-----------|---------------------------------------------|----------------------------------|
| Undo  | `users.id = 1`인 Row의 변경 전 값 (예: age = 25)| 트랜잭션 롤백을 위한 정보     |
| Redo  | `users.id = 1`인 Row의 변경 후 값 (예: age = 30) | 시스템 장애 시 재실행을 위한 정보 |

#### 저장 순서 요약

1. 트랜잭션이 `UPDATE`를 실행함  
2. Undo 로그에 먼저 변경 전 데이터를 저장 (ex: `age = 25`)  
3. Redo 로그에 이후 변경 후 데이터를 저장 (ex: `age = 30`)  
4. 이후 실제 데이터 블록이 변경됨  
5. 트랜잭션이 `COMMIT`되면, Redo 로그가 디스크로 플러시됨  

#### 시나리오별 사용 예

#### 1. 트랜잭션 롤백 발생

- `ROLLBACK;` 실행 시  
- → Undo 로그를 사용해 `age = 25`로 복원  

#### 2. 시스템 장애 발생 (COMMIT 전)

- 데이터 파일은 변경 중이었지만, 장애로 일부만 반영됨  
- → Redo 로그를 사용해 `age = 30`으로 다시 적용 (재실행)  

#### 시각적 요약

```plaintext
           트랜잭션 실행
              ↓
    [UNDO]  age = 25 ← 롤백용
    [REDO]  age = 30 ← 재실행용
              ↓
     실제 블록 수정 (age = 30)
```