# Union

- Join은 여러 테이블을 옆으로(수평으로) 붙여서 더 많은 정보를 가진 컬럼을 만들어 내는 기술
- UNION은 여러 개의 결과 집합을 아래로(수직으로) 이어 붙여서 더 많은 행을 가진 하나의 집합으로 만드는 기술
  - JOIN이 정보를 풍성하게 만드는 기술이라면, UNION은 흩어진 집합들을 하나로 모으는 기술이라고 할 수 있다
- 문제 상황: `우리 쇼핑몰은 현재 활동 중인 고객을 users 테이블에, 과거에 탈퇴한 고객을 retired_users라는 별도의 테이블에 보관하고 있다. 연말을 맞아 모든 고객(활동+탈퇴)에게 감사 이메일을 보내기 위해, 두 테이블에 흩어져있는 이름과 이메일을 합쳐 전체 목록을 만들어야 한다`
  - 해당 문제는 JOIN으로 해결할 수 없다
  - 두 테이블은 서로 연결된 관계가 아니라, 구조는 비슷하지만 분리된 별개의 집합이기 때문이다

## 핵심 규칙

- UNION으로 연결되는 모든 SELECT문은 컬럼의 개수가 동일해야 한다
- 각 SELECT 문의 같은 위치에 있는 컬럼들은 서로 호환 가능한 데이터 타입이어야 한다(숫자는 숫자, 문자는 문자끼리)
- 최종 결과의 컬럼 이름은 첫 번째 SELECT문의 컬럼 이름을 따른다
- 두 결과 집합을 합친 뒤 완전히 중복되는 행은 자동으로 제거하여 고유한 값만 남긴다
  - 중복 처리를 하지 않기 위해서는 `UNION ALL`을 사용해야 한다
```SQL
select name, email, created_at from users 
union
select name, email, retired_date from retired_users
order by name;
```
- 먼저 입력된 컬럼명으로 결과가 출력된다
- 마지막 order by로 집계 결과가 최종 sorting된다

## UNION(중복 제거) VS UNION ALL(중복 제거X)

- UNION ALL이 UNION보다 훨씨니 빠르다
- UNION은 두 결과를 합친 뒤, 중복을 제거하기 위해 데이터베이스는 보이지 않는 곳에서 추가 작업을 해야 한다
  - 전체 결과를 Sort한 다음 서로 인접한 행들을 비교하여 중복을 찾아내는 과정을 거친다
  - 데이터 양이 수백만 건이라면 이 정렬과 비교 작업은 엄청난 비용과 시간을 소모한다
- UNION ALL은 추가 작업이 전혀 없다
  - 첫 번째 SELECT 결과 아래 두 번째 SELECT 결과를 가져다 붙이기만 하면 된다

### 실무에서는?

- 중복을 제거해야만 하는 명확한 요구사항이 있을 때만 UNION을 사용한다(e.g.고유한 이메일 주소목록, 고유한 고객 ID목록 등)
- 그 외의 모든 경우는 UNION ALL을 우선적으로 사용한다
- 불필요한 UNION 사용은 쿼리를 느리게 만드는 주범이 될 수 있다