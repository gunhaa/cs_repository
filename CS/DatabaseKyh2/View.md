# View

- VIEW는 실제 데이터를 가지고 있지 않은 가상의 테이블이다
  - 그 실체는 데이터베이스에 이름과 함께 저장된 하나의 SELECT 쿼리문이다
- 컴퓨터 바탕화면의 '바로가기Shortcut'를 생각하면 쉽다
  - 바로 가기 아이콘은 그 자체로 프로그램 파일이 아니며, 위치정보만 담고있다
  - 우리는 복잡한 경로를 찾아갈 필요 없이 바로가기 아이콘을 더블클릭하는 것만으로 프로그램을 실행할 수 있다
- 뷰도 이와 같다
  - 뷰는 그 자체로 데이터를 저장하는 테이블이 아니다
    - 단지 복잡한 SELECT 쿼리문 자체를 저장하고있다
  - 우리는 복잡한 쿼리를 실행할 필요 없이 `select * from 나의_바로가기_뷰;` 라는 간단한 명령만으로 복잡한 쿼리의 결과를 얻을 수 있다

## View 테이블이 필요한 상황
```sql
select 
	p.category,
	count(*) as total_orders,
	sum(case when status = 'COMPLETED' then 1 else 0 end) as completed_count,
	sum(case when status = 'SHIPPED' then 1 else 0 end) as shipped_count,
	sum(case when status = 'PENDING' then 1 else 0 end) as pending_count
from orders o
join products p on o.product_id = p.product_id
group by p.category;
```
- 위 쿼리를 회사에서 매일 사용하는 쿼리라고 가정할 경우 여러가지 문제상황이 발생한다
  1. 복잡성: 이 쿼리는 너무 길고 복잡하다. SQL에 익숙하지 않은 직원이 이 쿼리를 매번 실수 없이 입력하기란 불가능하다
  2. 재사용성: 여러 팀의 사람이 이 쿼리를 사용하려면 각자 이 긴 쿼리문을 어딘가에 저장해두고 복사-붙여넣기를 해야한다. 만약 보고서의 로직이 변경되면(e.g. '반품 완료'상태 추가), 모든 사람이 각자 저장해 둔 쿼리를 수정해야하는 끔찍한 상황이 벌어진다
  3. 보안: 이 쿼리를 실행하려면 사용자는 원본 테이블인 orders와 products에 직접 접근할 수 있는 권한이 있어야한다. 하지만 운영팀 직원에게는 고객의 개인정보나 상품의 원가 같은 민감한 정보가 담겨있을 수 있는 원본 테이블 전체를 보여주고 싶지 않은 경우
- 이 복잡한 쿼리 자체를 데이터베이스에 하나의 '바로 가기' 처럼 저장해두고 필요할 때마다 간단한 이름으로 불러 쓸 수는 없을까?
  - 이 모든 문제를 한 번에 해결해 주는 마법 같은 도구가 VIEW이다

## VIEW의 동작원리 

- 사용자가 `v_category_order_status` 라는 뷰를 조회하면, 데이터베이스 내부에서는 다음과 같은 일이 일어난다.
1. 사용자가 `SELECT * FROM v_category_order_status;` 라는 쿼리를 실행한다.
2. 데이터베이스는 `v_category_order_status` 라는 이름의 실제 테이블을 찾지 않는다. 대신, 이 뷰에 정의된
(저장된) 원래의 긴 `SELECT` 쿼리문을 찾아낸다.
3. 데이터베이스는 그 저장된 `SELECT` 쿼리문(우리가 위에서 만든 복잡한 쿼리)을 그 순간에 실행*다.
4. 실행 결과가 사용자에게 반환된다. 사용자는 마치 그냥 테이블을 조회한 것처럼 느끼게 된다.
여기서 중요한 점은, 뷰는 데이터를 저장하지 않기 때문에, 우리가 뷰를 조회할 때마다 항상 최신 상태의 원본 테이블
( `orders` , `products` )을 기준으로 쿼리가 실행된다는 것이다. 따라서 뷰의 데이터는 항상 최신 상태를 유지한다.

## VIEW를 사용하는 이유

1. 편리성: 복잡한 쿼리를 단순화하여 쉽게 재사용할 수 있다.
2. 보안성: 사용자에게 원본 테이블에 대한 접근 권한을 주지 않고, 뷰를 통해서만 제한된 데이터(특정 행이나 특정
컬럼)에 접근하도록 허용할 수 있다. 민감한 정보를 숨기는 데 매우 효과적이다.
3. 논리적 독립성: 만약 나중에 원본 테이블의 구조가 일부 변경되더라도, 뷰의 정의만 수정하면 뷰를 사용하는 응용
프로그램은 코드를 바꿀 필요가 없을 수도 있다. 뷰가 중간에서 변화를 흡수하는 '추상화 계층' 역할을 하기 때문이
다.
- 뷰는 단순히 편의 기능이 아니라, 데이터베이스의 보안과 유지보수성을 크게 향상시키는 실무의 핵심 기능이다.

## View의 장점과 단점

### 장점

1. 편리성과 재사용성
2. 보안성
3. 논리적 데이터 독립성

### 단점

1. 성능 문제
  - 착각
    - 사용자는 자신이 가벼운 쿼리를 날린다고 착각하지만 실제로는 시스템에 큰 부하를 주는 큰 쿼리를 날리고 있을 수 있다
  - 최적화의 한계
    - Database의 optimizer는 똑똑하지만, 뷰의 구조가 너무 복잡해지면 최적의 실행 계획을 찾아내는데 어려움을 겪을 수 있다
    - 특히 뷰위에 뷰를 쌓는 방식(Nested Views)은 성능 저하의 주된 원인이 되므로 가급적 피해야한다
2. 업데이트 제약
  - 뷰를 테이블처럼 다룰 수 있다고 했지만, 그것은 주로 조회(읽기)에 국한된 이야기다(VIEW도 INSERT/UPDATE 쿼리가 가능하다)
    - 수정 불가(대부분의 경우)
      - 복잡한 VIEW는 일반적으로 insert, update, delete가 불가능하다
      - Database의 입장에서 뷰의 한 행을 수정하는 것이 원본 테이블들의 데이터를 어떻게 바꿔야하는지에 대한 명확한 규칙을 특정할 수 없기 때문이다
    - 수정 가능
      - 뷰가 오직 하나의 기본 테이블만 참조하고, 뷰의 모든 컬럼이 기본 테이블의 실제 컬럼을 직접 참조하는 경우에는 뷰에 데이터를 추가/수정 할 수 있다
        - 이 경우 원본 테이블의 값이 변경된다
    - 실무 규칙
      - '뷰는 기본적으로 조회용이다'라고 생각하는 것이 일반적인 원칙이다
      - 데이터를 수정해야 한다면 뷰가 아닌 원본 테이블에 직접 수행해야 한다
- 뷰는 만능 해결책이 아니다
- 복잡한 로직을 편리하게 재사용하고 보안을 강화하는 데는 좋은 도구지만 성능 저하의 가능성을 내포하고 있으며 데이터 수정에는 제약이 따른다는 한계를 가지고 있다