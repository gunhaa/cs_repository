# 데이터 무결성

## 데이터 무결성이 중요한 이유

- 컴퓨터 과학의 유명한 격언 'Garbage In, Garbage Out(GIGO)'가 있다
  - 쓰레기가 들어가면, 쓰레기가 나온다는 뜻으로 잘못된 데이터가 들어간 순간 그 데이터를 기반으로한 모든 분석, 보고서, 그리고 애플리케이션의 동작은 신뢰를 잃고 심각한 오류를 야기하게 된다는 것이다
- 생각보다 데이터 무결성을 침범하는 오류는 자주 일어나고, 한번 발생하게되면 그와 관련된 Database의 모든 Table들을 찾아서 처리해야 하므로 문제를 해결하기가 굉장히 어려워 주의해야 한다

## 기본 제약 조건

> 하나의 테이블 안에서 데이터의 유효성을 지키는 규칙

- NOT NULL: NULL 값 방지
- UNIQUE: 중복 값 방지
- Primary key(기본키)
  - 테이블의 각 행을 고유하게 식별할 수 있는 단 하나의 대표키
  - NOT NULL과 UNIQUE 제약 조건의 특징을 모두 포함한다, 즉 Primary key는 절대 NULL일수 없으면 절대 중복 될 수 없다
  - 테이블당 오직 하나만 설정할 수 있으며, 이 기본 키를 기준으로 데이터가 저장되고 검색되므로 성능에도 매우 중요한 역할을 한다(MySQL은 기본키에 자동으로 고성능 인덱스를 생성한다, 클러스터 인덱스)
- DEFAULT: 기본 값 설정
  - 무결성을 강제하는 규칙이라기보다는, 데이터 누락을 방지하고 입력을 편리하게 해주는 기능에 가깝다

## 외래 키 제약 조건

> 유령 데이터를 막기 위한 제약 조건

> FK는 성능을 위해 제거하고, 어플리케이션 레벨에서 체크하는 경우도 많다

- 참조 무결성(Referential Integrity)을 지키기 위한 제약이다
  - 참조 무결성이란 두 테이블의 관계가 항상 유효하고 일관된 상태를 유지해야 한다는 원칙이다
- 테이블 간의 관계 무결성을 강제하는 가장 강력한 제약조건이다

### 외래키의 ON DELETE / ON UPDATE 옵션

- RESTRICT(기본값): 자식 테이블에 참조하는 레코드가 있으면 부모 테이블의 레코드를 삭제/수정할 수 없다
- CASCADE: 부모 테이블의 레코드가 삭제/수정되면 그를 참조하는 자식 테이블의 레코드도 함께 자동으로 삭제/수정 된다
- SET NULL: 부모 테이블의 행이 삭제/수정되면, 자식 테이블의 해당 외래 키 컬럼을 NULL로 설정한다(이 옵션을 사용하기 위해선 자식 테이블의 외래 키 컬럼이 NULL을 허용해야 한다)

### 실무: CASCADE

> 사실상 CASCADE 옵션을 사용하지 않는다

- CASCADE 옵션은 편리한 기능이지만 잘못 사용할 경우 예상치 못한 대량의 데이터가 함께 삭제된다
- 특히 관계가 복잡할 경우 파급 효과를 예측하기 어렵다
- 대신 애플리케이션 계층에서 명시적으로 관련된 데이터를 처리하는 방식으로 처리한다

### 실무: 외래키 제약 조건

- 성능때문에 제거하는 경우도 있지만, 제약 조건이 없을 경우 잘못 다뤄서 생기는 데이터 정합성 오류는 매우 치명적이다
  - 외래키 제약 조건이 없다면 데이터 정합성 오류가 많이 발생하고, 복구하기가 매우 힘들다
- 규모가 작을때는 제약 조건을 넣고, 규모가 커져서 성능에 대해 더 중요한 고민을 해야한다면 제거하는 방향을 추천한다

## CHECK 제약 조건

- 데이터의 내용에 대한 규칙
  - e.g. 상품의 가격이나 재고 수량은 절대 음수일 수 없다
  - 할인률은 0%~100% 사이여야한다
- 특정 컬럼에 들어갈 수 없는 값의 범위나 조건을 직접 지정해, 강화된 비즈니스 규칙을 적용하고 싶을 때 사용한다
- Check제약 조건은 특정 컬럼에 대해 INSERT나 UPDATE가 일어날 때 마다 TRUE/FALSE를 검사한다

### 실무: 데이터 검증 위치

- 요즘 대세는 애플리케이션에서 비즈니스 로직과 유효성 검사를 처리하는 것이다
  - 훨씬 유연하고 테스트하기 쉽다
- DB CHECK 제약 조건은 신중하게
- 최후의 방어선으로 활용하는 것이 좋다
